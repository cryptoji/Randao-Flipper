# Ether Flipper
Смарт контракт для проведения лотерей.

### Введение
Если вы слышали об онлайн казино, лото и других лотереях то наверняка вы понимаете что все подобные игры базируются на случайных числах (рандоме). Множество подобных проектов максимально непрозрачны и в большинстве случае вы играете против казино по его правилам и на его территории, рандом же определяется за кулисами по неизвестным вам алгоритмам. При такой монополии и закрытости игроки часто сталкиваются с проблемами несправедливого выбора победителя в пользу казино или вовсе отказе или максимальном усложнении выплаты честно заработанного приза.
Ether Flipper это максимально простая в правилах и логике лотерея, где игрокам заранее известны все условия и шансы на победу. Рандом который определяет победителей формируют сами участники игры. Это полностью децентрализованная автономная система развернутая в блокчейне Ethereum и неподконтрольная никому, лишь немногие действия по модерированию доступны владельцу контракта, но даже при желании никто не сможет повлиять на процессы выбора победителей и  распределения призового фонда.
У всего есть преимущества и недостатки, наша система спроектирована с упором на децентрализацию, автономность работы и как следствие полную прозрачность. Поскольку мы не используем никаких дополнительных бекэнд-серверов и БД, вся логика и все данные хранятся в блокчейне. В силу этого каждое действие пользователя будь то принятие участия в игре или получение выигрыша сопровождается необходимостью формирования транзакции, поэтому система не выплачивает призы в автоматическом режиме. Если вы оказались победителем тогда вам понадобится отправить транзакцию в смарт-контракт и только так можно получить выигрыш.
Исходя из сложности взаимодействия пользователя с контрактом напрямую, мы предлагаем нашим игрокам минималистичный и простой UI интерфейс, который делает работу с контрактом максимально интуитивной и простой. Единственное требование для пользователя это наличие плагина для браузера MetaMask.

### Алгоритм
1. Создаются различные игровые конфигурации;
2. Создается игра с одной из созданных ранее конфигураций;
    * Создатель игры становится ее первым участником, и как все остальные вводит любое число которое в его браузере превращается в sha256 хэш и сохраняется в контракте;
    * Делает первый депозит, другие игроки должны будут его поддержать и  внести равное количество токенов;

3. Добавление игроков (commits);
    * К игре добавляются новые игроки, они оправляют транзакции с суммой эквивалентной сумме депозита игры и с хешем придуманного ими числа;
    * Добавится к игре можно только если еще не набрано нужное количество участников и срок игры не подошел к концу;
    * Переход от этапа commits к rewards происходит автоматически как только все участники собраны;

4. Раскрытие чисел (reveals);
    * Раскрыть число можно в случае если срок игры еще не вышел и она не находится в статусе завершенной или закрытой;
    * На этом этапе игроки раскрывают свои числа. Контракт приводит их к хэшу и сравнивает с тем хешем что был введен на стадии commit. Таким образом исключается любая возможность злоумышленника узнать числа других игроков на первом этапе, когда эта информация является критически важной и может быть использована последним игроком для выбора нужного ему числа чтобы попасть в список победителей;
    * Каждое раскрытое игроком число используется для выведения итогового случайного числа игровой сессии по формуле: R = p1.n + p2.n … + pN.n; Где p это игрок, p.n его число и r общее случайно число игры.

5. Завершение игры (complete);
    * Эта функция вызывается любым участником игры после этапа раскрытия чисел.
    * Она использует имеющееся случайное число для получения номера первого победителя по формуле: W1 = (R + block.number) % P; Где W1 это первый победитель, R рандомное число полученное на этапе reveal, block.number текущий блок, P количество участников;
    * Оставшиеся победители это N номеров следующих после первого, где N количество победителей -1. Если W1 + N > P, где P количество участников тогда W1 смещается на -1 пока W1 + N не будет равно P. Если например рандомное число в конфигурации игры с 10 участниками и 3 победителями будет равно 0, значит победителями станут первые 3 участника из 10, если 5 то победителями будут 5,6,7 участники а если выпадет например 9 тогда победителями станут 7,8,9 участники.
    * Это считается справедливым выбором победителей так как в любом случае W1 определяется рандомно путем суммирования всех чисел принятых от участников, поэтому спрогнозировать конечных победителей на этапе когда в игру еще можно войти становится невозможно. В идеальном варианте на каждого участника должно выбираться рандомное число, но поскольку в блокчейне все данные открыты и нет возможности тривиального получения случайного числа, игра построена таким образом что игроки сами его генерируют.

6. Получение призов (rewards);
    * Этот этап становится возможным только в случае если игра завершена или закрыта. В первом случае победители получат назад свои токены + долю от призового фонда который является суммой депозитов всех проигравших игроков (в том числе и тех кто до конца игры не раскрыл свое число)

### Игровая сессия
Игровая сессия это структура включающая в себя:
* Participants - список участников игры и адресов их кошельков. Лимит количества участников определяется конфигураций игры. Первым участником в игре становится ее создатель, остальные игроки добавляются после.
* Winners - список адресов победителей, только они смогут забрать приз поделенный между ними поровну за вычетом комиссии контракта.

### Конфигурация игры
Конфигураций может быть множество, каждая из них задает ключевые параметры игры. Управлять конфигурациями может только owner.
* Participants Number - количество участников игры.
* Winners Number - количество победителей. Не может быть больше чем (Participants Number-1) и меньше 1.
* Duration - длительность игры с момента ее создания. Измеряется в блоках. После этого срока (либо по факту готовности всех участников) становится возможным получение выигрыша или закрытие игры в случае если не один из участников не подтвердил свой номер.

### Участник игры
Участник игры имеет несколько статусов а именно прошел ли он первый, второй этапы и получил ли он свою награду. Идентификатором участника служит адрес кошелька с которого он зашел в первый этап игровой сессии.

### Уязвимости и слабые места
Если злоумышленник обладает достаточными вычислительными ресурсами то он может зная адреса всех участников игры и переданные ими хеши заранее подготовить выборки хешей и их значений на каждого участника где хэш = <от 1 до N возможных номеров, адрес участника>. Когда в игру заходит новый игрок злоумышленник подбирает под него хэш проверяя на соответствие тому что ввел сам игрок. После того как предпоследний игрок зашел в игру и в случае если его хэш вычислен злоумышленник может получить последовательность чисел игроков до этапа их раскрытия. Следовательно зная алгоритм подсчета победителей, последовательность введенных игроками чисел и будучи последним игроком он может вычислить нужное число чтобы он оказался в списке победителей.
Вариантом защиты от таких действий видится введение умеренной мотивации сторонним пользователям заходить в игровую сессию последними и получать за это небольшие бонусы, чтобы количество времени на подбор последнего хеша было минимальным. Но это необходимо сделать так чтобы все игроки не стремились зайти последними. Либо же в случае если только owner может открывать сессии и быть последним участником в них, но в таком случае игроки не застрахованы от того что сам owner и окажется злоумышленником.
